<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RobPac Resources</title>
  <meta name="description" content="Premium multi-format digital resources for entrepreneurs." />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://payhip.com/payhip.js" type="text/javascript"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .popup-overlay { backdrop-filter: blur(4px); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .line-clamp-1 { display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .line-clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .product-card { cursor:pointer; transition: transform .18s, box-shadow .18s, border-color .18s; }
    .product-card:hover { transform: translateY(-3px); box-shadow: 0 16px 22px -10px rgb(0 0 0 / 0.18); border-color: rgb(191 219 254); }
    .product-image-wrapper {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      display:flex; align-items:center; justify-content:center;
      padding:.5rem; aspect-ratio: 1 / 1;
    }
    .product-image { width:100%; height:100%; object-fit:contain; max-height: 160px; }
  </style>
</head>

<body class="bg-gray-50">
<!-- ROBPAC_RESOURCES_BUILD: UPSELL_RECOMMENDATIONS_V2 -->

<header class="bg-white border-b border-gray-200 sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="RobPac Resources" class="h-14 w-14 sm:h-16 sm:w-16" />
        <div>
          <div class="text-lg sm:text-xl font-extrabold text-gray-900 tracking-tight">ROBPAC RESOURCES</div>
          <div class="text-xs text-gray-500 uppercase tracking-wide">Digital Products</div>
        </div>
      </div>

      <nav class="hidden md:flex items-center space-x-8">
        <a href="#home" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
        <a href="#catalog" class="text-gray-700 hover:text-blue-600 font-medium">Browse</a>
        <a href="#faq" class="text-gray-700 hover:text-blue-600 font-medium">FAQ</a>
        <a href="https://robpacpublishing.com" class="text-gray-700 hover:text-blue-600 font-medium">Main Site</a>
      </nav>

      <button id="mobileMenuBtn" class="md:hidden p-2 rounded-lg border border-gray-200 hover:bg-gray-50" type="button" aria-label="Open menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>

    <div id="mobileMenu" class="md:hidden hidden mt-4 border-t border-gray-100 pt-4">
      <div class="flex flex-col gap-3">
        <a href="#home" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
        <a href="#catalog" class="text-gray-700 hover:text-blue-600 font-medium">Browse</a>
        <a href="#faq" class="text-gray-700 hover:text-blue-600 font-medium">FAQ</a>
        <a href="https://robpacpublishing.com" class="text-gray-700 hover:text-blue-600 font-medium">Main Site</a>
      </div>
    </div>
  </div>
</header>

<section id="home" class="bg-gradient-to-b from-white to-gray-50 py-12 sm:py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
    <div class="inline-flex items-center gap-2 bg-blue-50 text-blue-700 text-sm font-semibold px-4 py-2 rounded-full mb-5">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      New resources added regularly
    </div>

    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-gray-900 mb-4 leading-tight">
      Premium Digital Resources<br class="hidden sm:block" />for Entrepreneurs
    </h1>

    <p class="text-base sm:text-lg text-gray-600 mb-7 max-w-3xl mx-auto">
      Multi-format products: guides, templates, audio programs, and more. Open any item to view details and checkout via Payhip.
    </p>

    <div class="flex flex-col sm:flex-row gap-3 justify-center">
      <a href="#catalog" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition">Browse Catalog</a>
      <a href="#categories" class="bg-white text-blue-600 border border-blue-200 font-semibold px-6 py-3 rounded-lg hover:bg-blue-50 transition">Browse by Category</a>
    </div>
  </div>
</section>

<section class="py-9 bg-white" id="categories">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-end justify-between gap-6 mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-900">Browse by Category</h2>
        <p class="text-gray-600 mt-1">Select a category to jump into the catalog.</p>
      </div>
      <a href="#catalog" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">Go to catalog</a>
    </div>

    <div id="categoryCards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4"></div>
  </div>
</section>

<section class="py-12" id="catalog">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-gray-900 mb-3">Browse Our Catalog</h2>
      <p class="text-gray-600">Fast filters and search, built to scale to hundreds of products.</p>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 sm:p-6">
      <div class="grid gap-4 lg:grid-cols-12">
        <div class="lg:col-span-4">
          <label for="searchInput" class="text-sm font-semibold text-gray-900">Search</label>
          <input id="searchInput" type="text" class="mt-2 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Search title or description..." />
        </div>

        <div class="lg:col-span-3">
          <label for="categorySelect" class="text-sm font-semibold text-gray-900">Filter by Category</label>
          <select id="categorySelect" class="mt-2 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
            <option value="">All Categories</option>
          </select>
        </div>

        <div class="lg:col-span-3">
          <label for="subcategorySelect" class="text-sm font-semibold text-gray-900">Subcategory</label>
          <select id="subcategorySelect" class="mt-2 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" disabled>
            <option value="">All Subcategories</option>
          </select>
        </div>

        <div class="lg:col-span-2">
          <label for="priceSelect" class="text-sm font-semibold text-gray-900">Price</label>
          <select id="priceSelect" class="mt-2 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
            <option value="all">All</option>
            <option value="under15">Under $15</option>
            <option value="15to30">$15–$30</option>
            <option value="30plus">$30+</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-2">
        <div class="text-sm font-semibold text-gray-900 mr-2">Format</div>
        <div id="formatChips" class="flex flex-wrap gap-2"></div>
        <button id="clearFiltersBtn" class="ml-auto text-sm font-semibold text-blue-600 hover:text-blue-700" type="button">Clear</button>
      </div>

      <div class="mt-5 flex items-center justify-between gap-4">
        <div class="text-sm text-gray-600"><span id="resultsCount" class="font-semibold text-gray-900">0</span> results</div>
        <button id="loadMoreBtn" class="hidden bg-white text-blue-600 border border-blue-200 font-semibold px-4 py-2 rounded-lg hover:bg-blue-50 transition text-sm" type="button">Load more</button>
      </div>

      <div id="productsGrid" class="mt-6 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    </div>
  </div>
</section>

<section class="py-12 bg-white" id="faq">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-9">
      <h2 class="text-3xl font-bold text-gray-900 mb-3">FAQ</h2>
      <p class="text-gray-600">Access, licensing, and delivery.</p>
    </div>

    <div class="max-w-3xl mx-auto space-y-4">
      <details class="bg-gray-50 rounded-xl p-5 border border-gray-200">
        <summary class="cursor-pointer font-semibold text-gray-900">How do I access my purchase?</summary>
        <div class="mt-3 text-gray-700 text-sm leading-relaxed">After checkout, Payhip provides an instant download link and a confirmation email.</div>
      </details>

      <details class="bg-gray-50 rounded-xl p-5 border border-gray-200">
        <summary class="cursor-pointer font-semibold text-gray-900">Do products include commercial use?</summary>
        <div class="mt-3 text-gray-700 text-sm leading-relaxed">Where specified, you can use resources in your business. Always follow the licensing terms included with each item.</div>
      </details>

      <details class="bg-gray-50 rounded-xl p-5 border border-gray-200">
        <summary class="cursor-pointer font-semibold text-gray-900">Can I get a refund?</summary>
        <div class="mt-3 text-gray-700 text-sm leading-relaxed">A guarantee may be available on eligible products. Use your Payhip receipt details to reference your order.</div>
      </details>
    </div>
  </div>
</section>

<!-- Product Detail Modal -->
<div id="productModal" class="hidden fixed inset-0 z-50 bg-black/40 popup-overlay flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full relative">
    <button type="button" onclick="closeProductModal()" class="absolute top-3 right-3 p-2 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-50" aria-label="Close">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <div id="productModalContent" class="p-4 sm:p-5 max-h-[70vh] overflow-y-auto"></div>
  </div>
</div>

<footer class="bg-gray-900 text-gray-300 py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid md:grid-cols-4 gap-8 mb-8">
      <div>
        <div class="flex items-center gap-2 mb-4">
          <img src="logo.png" alt="RobPac Resources" class="h-10 w-10" />
          <div class="text-white font-bold">ROBPAC RESOURCES</div>
        </div>
        <p class="text-sm">Premium digital resources for modern entrepreneurs.</p>
      </div>

      <div>
        <h3 class="text-white font-semibold mb-4">Quick Links</h3>
        <div class="space-y-2 text-sm">
          <a class="block hover:text-white" href="#catalog">Browse Catalog</a>
          <a class="block hover:text-white" href="#faq">FAQ</a>
          <a class="block hover:text-white" href="https://robpacpublishing.com">Main Site</a>
        </div>
      </div>

      <div>
        <h3 class="text-white font-semibold mb-4">Categories</h3>
        <div id="footerCategories" class="space-y-2 text-sm"></div>
      </div>

      <div>
        <h3 class="text-white font-semibold mb-4">Support</h3>
        <div class="space-y-2 text-sm">
          <a class="block hover:text-white" href="mailto:robpacpublishing@gmail.com">robpacpublishing@gmail.com</a>
        </div>
      </div>
    </div>

    <div class="border-t border-gray-800 pt-8 text-center text-sm">
      <p>© 2025 RobPac Resources - A Division of <a class="text-blue-400 hover:text-blue-300" href="https://robpacpublishing.com">RobPac Publishing</a></p>
    </div>
  </div>
</footer>

<script>
  var CATEGORIES = [
    {"name":"Marketing","subcategories":["SEO","Ads","Email","Content"]},
    {"name":"Sales & Conversion","subcategories":["Funnels","Copywriting","Offers"]},
    {"name":"Business & Growth","subcategories":["Strategy","Operations","Finance"]},
    {"name":"Creator & Media","subcategories":["YouTube","Social","Branding"]},
    {"name":"Productivity & Systems","subcategories":["Planning","Automation","Focus"]},
    {"name":"Mindset & Personal Growth","subcategories":["Habits","Confidence"]},
    {"name":"Career & Freelancing","subcategories":["Clients","Portfolio"]},
    {"name":"Health & Wellness","subcategories":["Stress","Energy"]},
    {"name":"Technology & Security","subcategories":["AI Tools","Security"]},
    {"name":"Special Topics","subcategories":["Checklists","Workflows"]}
  ];

  var FORMAT_LABELS = {"video":"VIDEO","guide":"GUIDE","book":"BOOK","audio":"AUDIO","template":"TEMPLATE","workbook":"WORKBOOK","prompt":"PROMPT PACK","checklist":"CHECKLIST"};

  // Products: optional fields for upsell/bundles:
  // - payhipId: string (single product)
  // - bundlePayhipId: string (bundle product on Payhip, optional)
  // - bundleLabel: string (optional label for bundle CTA)
  // - bundleNote: string (optional short note under bundle CTA)
  var FALLBACK_PRODUCTS = [
    {"id":"p-content-multiplier","title":"Content Multiplier - Prompt Pack","mainCategory":"Creator & Media","subCategory":"Social","format":"prompt","description":"Turn one piece of content into multiple formats with ready-to-use prompts.","info":"Prompt Pack","price":15,"compareAt":25,"payhipId":"rQWRZ","bundlePayhipId":"","bundleLabel":"","bundleNote":"","cover":"content-multiplier.png"},
    {"id":"p-90day-planner","title":"90-Day Business Planner","mainCategory":"Business & Growth","subCategory":"Operations","format":"workbook","description":"Quarterly planning system with goal tracking and weekly reviews.","info":"Fillable • 50 pages","price":12,"compareAt":17,"payhipId":"","bundlePayhipId":"","bundleLabel":"","bundleNote":"","cover":"90-day-business-planner.png"},
    {"id":"p-email-blueprint","title":"Email Marketing Blueprint","mainCategory":"Marketing","subCategory":"Email","format":"guide","description":"Build and monetize your email list with a structured plan.","info":"PDF • 68 pages","price":17,"compareAt":27,"payhipId":"","bundlePayhipId":"","bundleLabel":"","bundleNote":"","cover":"email-marketing-blueprint.png"},
    {"id":"p-funnel-blueprint","title":"Sales Funnel Blueprint","mainCategory":"Sales & Conversion","subCategory":"Funnels","format":"book","description":"Build funnels step-by-step with examples and structure.","info":"PDF • 120 pages","price":27,"compareAt":37,"payhipId":"","bundlePayhipId":"","bundleLabel":"","bundleNote":"","cover":"sales-funnel-blueprint.png"},
    {"id":"p-productivity-audio","title":"Productivity Mastery","mainCategory":"Productivity & Systems","subCategory":"Focus","format":"audio","description":"Audio lessons to build a calmer, stronger routine.","info":"MP3 • 2 hours","price":27,"compareAt":37,"payhipId":"","bundlePayhipId":"","bundleLabel":"","bundleNote":"","cover":"productivity-mastery.png"},
    {"id":"p-instagram-kit","title":"Instagram Content Kit","mainCategory":"Creator & Media","subCategory":"Social","format":"template","description":"Templates to speed up posting and keep style consistent.","info":"Canva + PDF","price":12,"compareAt":17,"payhipId":"","bundlePayhipId":"","bundleLabel":"","bundleNote":"","cover":"instagram-marketing-mastery.png"}
  ];
  var PRODUCTS = [];

  function inferFormatFromLabel(label) {
    var v = String(label || "").toLowerCase();
    if (!v) return "book";
    if (v.indexOf("video") !== -1) return "video";
    if (v.indexOf("audio") !== -1) return "audio";
    if (v.indexOf("workbook") !== -1) return "workbook";
    if (v.indexOf("template") !== -1) return "template";
    if (v.indexOf("prompt") !== -1) return "prompt";
    if (v.indexOf("checklist") !== -1) return "checklist";
    if (v.indexOf("guide") !== -1) return "guide";
    if (v.indexOf("book") !== -1) return "book";
    return "book";
  }

  function adaptProductFromJson(rec, idx) {
    if (!rec || !rec.title) return null;

    function toNumber(val) {
      var n = parseFloat(String(val).replace(",", "."));
      return isNaN(n) ? null : n;
    }

    var price = toNumber(rec.price);
    var compare = toNumber(rec.oldPrice);

    var format = rec.format || rec.label || "";
    format = inferFormatFromLabel(format);

    return {
      id: rec.id || rec.slug || ("p-" + (idx + 1)),
      title: rec.title,
      mainCategory: rec.category || "Marketing",
      subCategory: rec.subcategory || "",
      format: format,
      description: rec.description || rec.shortDescription || "",
      info: rec.formatInfo || "",
      price: price != null ? price : 0,
      compareAt: compare,
      payhipId: rec.payhipId || "",
      bundlePayhipId: rec.bundlePayhipId || "",
      bundleLabel: rec.bundleLabel || "",
      bundleNote: rec.bundleNote || "",
      cover: rec.cover || ""
    };
  }

  function loadProductsFromJson() {
    return fetch("products.json", { cache: "no-store" })
      .then(function(resp) {
        if (!resp.ok) return [];
        return resp.json();
      })
      .then(function(list) {
        if (!Array.isArray(list) || !list.length) {
          PRODUCTS = FALLBACK_PRODUCTS.slice();
          return;
        }
        PRODUCTS = list.map(adaptProductFromJson).filter(function(p) { return !!p; });
      })
      .catch(function() {
        PRODUCTS = FALLBACK_PRODUCTS.slice();
      });
  }


  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function normalize(str) {
    return String(str || "").toLowerCase().trim();
  }

  function formatMoney(n) {
    var v = Number(n);
    if (!isFinite(v)) return "";
    return "$" + v.toFixed(0);
  }

  function initPayhipButtons() {
    try {
      if (window.Payhip && window.Payhip.Button && typeof window.Payhip.Button.init === "function") {
        window.Payhip.Button.init();
      }
    } catch (e) {}
  }

  function buildPayhipButton(payhipId, label, extraClasses) {
    if (!payhipId) return "";
    var cls = "payhip-buy-button inline-flex items-center justify-center w-full font-semibold py-2.5 rounded-lg transition text-sm " + (extraClasses || "bg-blue-600 text-white hover:bg-blue-700");
    return '<a class="' + cls + '" data-product="' + escapeHtml(payhipId) + '" data-theme="blue" href="https://payhip.com/b/' + escapeHtml(payhipId) + '">' + escapeHtml(label || "Buy Now") + '</a>';
  }

  function normalizeCoverPath(src) {
    var s = String(src || "").trim();
    if (!s) return "";
    if (/^https?:\/\//i.test(s)) return s;
    if (s.startsWith("/")) return s;
    if (s.startsWith("covers/")) return "/" + s;
    return "/covers/" + s;
  }

  function setImgSrcWithFallback(imgEl, originalSrc) {
    if (!imgEl) return;
    var src = normalizeCoverPath(originalSrc);
    if (!src) return;

    var tried = new Set();
    var base = src;
    var extMatch = base.match(/\.(png|jpg|jpeg|webp)$/i);
    var exts = ["png","jpg","jpeg","webp"];

    function nextSrc() {
      if (!extMatch) {
        // no extension: try common ones
        for (var i=0;i<exts.length;i++) {
          var candidate = base.replace(/\/$/, "") + "." + exts[i];
          if (!tried.has(candidate)) return candidate;
        }
        return "";
      }
      var currentExt = extMatch[1].toLowerCase();
      for (var j=0;j<exts.length;j++) {
        if (exts[j] === currentExt) continue;
        var cand = base.replace(new RegExp("\\." + currentExt + "$","i"), "." + exts[j]);
        if (!tried.has(cand)) return cand;
      }
      return "";
    }

    imgEl.onerror = function() {
      tried.add(imgEl.src);
      var n = nextSrc();
      if (n) {
        imgEl.src = n;
        return;
      }
      imgEl.onerror = null;
      imgEl.outerHTML = '<div class="w-full h-full flex items-center justify-center text-[11px] text-gray-400 bg-gray-50 border border-gray-200 rounded-lg">Cover missing</div>';
    };

    imgEl.src = src;
  }

  var STATE = {
    q: "",
    category: "",
    subcategory: "",
    formats: new Set(["all"]),
    price: "all",
    limit: 25
  };

  function buildSearchIndex() {
    PRODUCTS.forEach(function(p) {
      p.__search = normalize([p.title, p.description, p.mainCategory, p.subCategory, p.format, p.info].join(" "));
    });
  }

  function priceOk(price) {
    var p = Number(price) || 0;
    if (STATE.price === "under15") return p > 0 && p < 15;
    if (STATE.price === "15to30") return p >= 15 && p <= 30;
    if (STATE.price === "30plus") return p >= 30;
    return true;
  }

  function getActiveFormats() {
    if (STATE.formats.has("all")) return null;
    return Array.from(STATE.formats);
  }

  function filterProducts() {
    var q = normalize(STATE.q);
    var formats = getActiveFormats();

    return PRODUCTS.filter(function(p) {
      if (STATE.category && p.mainCategory !== STATE.category) return false;
      if (STATE.subcategory && p.subCategory !== STATE.subcategory) return false;
      if (formats && formats.length && formats.indexOf(p.format) === -1) return false;
      if (!priceOk(p.price)) return false;
      if (q && p.__search.indexOf(q) === -1) return false;
      return true;
    });
  }

  function renderCategoryCards() {
    var el = document.getElementById("categoryCards");
    if (!el) return;
    el.innerHTML = "";

    CATEGORIES.forEach(function(c) {
      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "text-left bg-white border border-gray-200 rounded-xl px-4 py-3 hover:border-blue-200 hover:shadow-sm transition";
      btn.innerHTML = '<div class="text-xs font-semibold text-gray-500">CATEGORY</div><div class="mt-1 font-bold text-gray-900">' + escapeHtml(c.name) + '</div>';
      btn.addEventListener("click", function() {
        setCategoryFilter(c.name);
      });
      el.appendChild(btn);
    });
  }

  function renderFooterCategories() {
    var el = document.getElementById("footerCategories");
    if (!el) return;
    el.innerHTML = "";
    CATEGORIES.slice(0, 6).forEach(function(c) {
      var a = document.createElement("a");
      a.href = "#catalog";
      a.className = "block hover:text-white";
      a.textContent = c.name;
      a.addEventListener("click", function(e) {
        e.preventDefault();
        setCategoryFilter(c.name);
      });
      el.appendChild(a);
    });
  }

  function renderCategorySelect() {
    var sel = document.getElementById("categorySelect");
    if (!sel) return;
    var current = sel.value || "";
    sel.innerHTML = '<option value="">All Categories</option>' + CATEGORIES.map(function(c) {
      return '<option value="' + escapeHtml(c.name) + '">' + escapeHtml(c.name) + '</option>';
    }).join("");
    sel.value = current;
  }

  function renderSubcategorySelect() {
    var sel = document.getElementById("subcategorySelect");
    if (!sel) return;

    if (!STATE.category) {
      sel.innerHTML = '<option value="">All Subcategories</option>';
      sel.disabled = true;
      return;
    }

    var c = CATEGORIES.find(function(x) { return x.name === STATE.category; });
    var subs = (c && c.subcategories) ? c.subcategories : [];
    sel.disabled = false;

    var current = sel.value || "";
    sel.innerHTML = '<option value="">All Subcategories</option>' + subs.map(function(s) {
      return '<option value="' + escapeHtml(s) + '">' + escapeHtml(s) + '</option>';
    }).join("");
    sel.value = current;
  }

  function makeChip(value, label) {
    return '<button type="button" data-format="' + escapeHtml(value) + '" class="px-3 py-1.5 rounded-full border text-xs font-semibold transition"></button>';
  }

  function updateChipUI() {
    var el = document.getElementById("formatChips");
    if (!el) return;

    el.querySelectorAll("[data-format]").forEach(function(btn) {
      var f = btn.getAttribute("data-format");
      var active = STATE.formats.has(f);
      btn.textContent = (f === "all") ? "All" : (FORMAT_LABELS[f] || f);
      btn.className = "px-3 py-1.5 rounded-full border text-xs font-semibold transition " +
        (active ? "bg-blue-600 text-white border-blue-600" : "bg-white text-gray-700 border-gray-200 hover:bg-gray-50");
    });
  }

  function renderFormatChips() {
    var el = document.getElementById("formatChips");
    if (!el) return;

    var formats = Object.keys(FORMAT_LABELS);
    var html = [];
    html.push(makeChip("all", "All"));
    formats.forEach(function(f) { html.push(makeChip(f, FORMAT_LABELS[f])); });
    el.innerHTML = html.join("");

    el.querySelectorAll("[data-format]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var f = btn.getAttribute("data-format");
        if (!f) return;

        if (f === "all") {
          STATE.formats = new Set(["all"]);
        } else {
          if (STATE.formats.has("all")) STATE.formats.delete("all");
          if (STATE.formats.has(f)) STATE.formats.delete(f);
          else STATE.formats.add(f);
          if (STATE.formats.size === 0) STATE.formats.add("all");
        }

        updateChipUI();
        STATE.limit = 25;
        renderCatalog();
      });
    });

    updateChipUI();
  }

  function renderCatalog() {
    var grid = document.getElementById("productsGrid");
    var countEl = document.getElementById("resultsCount");
    var loadMoreBtn = document.getElementById("loadMoreBtn");
    if (!grid || !countEl || !loadMoreBtn) return;

    var filtered = filterProducts();
    countEl.textContent = String(filtered.length);

    grid.innerHTML = "";
    var frag = document.createDocumentFragment();
    var shown = filtered.slice(0, STATE.limit);

    shown.forEach(function(p) {
      var card = document.createElement("div");
      card.className = "product-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden";
      card.setAttribute("data-product-id", p.id);

      var formatLabel = FORMAT_LABELS[p.format] || (p.format || "").toUpperCase();

      card.innerHTML =
        '<div class="product-image-wrapper">' +
          '<img data-cover="' + escapeHtml(p.cover || "") + '" alt="' + escapeHtml(p.title || "") + '" class="product-image" loading="lazy" />' +
        '</div>' +
        '<div class="p-3">' +
          '<div class="text-xs font-semibold text-gray-500 mb-1">' + escapeHtml(formatLabel) + '</div>' +
          '<div class="text-sm font-bold text-gray-900 line-clamp-2">' + escapeHtml(p.title) + '</div>' +
          (p.description ? '<div class="mt-1 text-xs text-gray-600 line-clamp-2">' + escapeHtml(p.description) + '</div>' : '') +
          '<div class="mt-3 flex items-baseline gap-2">' +
            '<div class="text-lg font-extrabold text-gray-900">' + escapeHtml(formatMoney(p.price)) + '</div>' +
            (p.compareAt ? '<div class="text-xs text-gray-500 line-through">' + escapeHtml(formatMoney(p.compareAt)) + '</div>' : '') +
          '</div>' +
          '<div class="mt-1 text-xs text-gray-500 line-clamp-1">' + escapeHtml(p.mainCategory) + (p.subCategory ? ' • ' + escapeHtml(p.subCategory) : '') + '</div>' +
        '</div>';

      card.addEventListener("click", function(e) {
        if (e.target.closest("a") || e.target.closest("button")) return;
        openProductModal(p);
      });

      frag.appendChild(card);
    });

    grid.appendChild(frag);

    grid.querySelectorAll("img[data-cover]").forEach(function(img) {
      setImgSrcWithFallback(img, img.getAttribute("data-cover"));
    });

    loadMoreBtn.classList.toggle("hidden", filtered.length <= STATE.limit);
  }

  function setCategoryFilter(cat) {
    STATE.category = cat || "";
    STATE.subcategory = "";
    STATE.limit = 25;

    var sel = document.getElementById("categorySelect");
    if (sel) sel.value = STATE.category;

    renderSubcategorySelect();
    var subSel = document.getElementById("subcategorySelect");
    if (subSel) subSel.value = "";

    renderCatalog();

    var catalog = document.getElementById("catalog");
    if (catalog) catalog.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function clearFilters() {
    STATE.q = "";
    STATE.category = "";
    STATE.subcategory = "";
    STATE.formats = new Set(["all"]);
    STATE.price = "all";
    STATE.limit = 25;

    var search = document.getElementById("searchInput");
    if (search) search.value = "";

    var cat = document.getElementById("categorySelect");
    if (cat) cat.value = "";

    var sub = document.getElementById("subcategorySelect");
    if (sub) {
      sub.value = "";
      sub.disabled = true;
      sub.innerHTML = '<option value="">All Subcategories</option>';
    }

    var price = document.getElementById("priceSelect");
    if (price) price.value = "all";

    updateChipUI();
    renderCatalog();
  }

  function isPurchasable(p) {
    return !!(p && (p.payhipId || p.bundlePayhipId));
  }

  function getRecommendations(product, limit) {
    var max = Number(limit) || 4;
    if (!product) return [];

    // Recommend only purchasable items (payhipId or bundlePayhipId),
    // otherwise we risk showing "N/A" suggestions that feel like broken products.
    var sameCat = PRODUCTS.filter(function(p) {
      return p.id !== product.id &&
             p.mainCategory === product.mainCategory &&
             isPurchasable(p);
    });

    // Prefer same subcategory, then closest price
    sameCat.sort(function(a,b) {
      var as = (a.subCategory && product.subCategory && a.subCategory === product.subCategory) ? 0 : 1;
      var bs = (b.subCategory && product.subCategory && b.subCategory === product.subCategory) ? 0 : 1;
      if (as !== bs) return as - bs;
      var ap = Math.abs((Number(a.price)||0) - (Number(product.price)||0));
      var bp = Math.abs((Number(b.price)||0) - (Number(product.price)||0));
      return ap - bp;
    });

    return sameCat.slice(0, max);
  }

  function openProductModal(product) {
    var modal = document.getElementById("productModal");
    var content = document.getElementById("productModalContent");
    if (!modal || !content || !product) return;

    var formatLabel = FORMAT_LABELS[product.format] || (product.format || "").toUpperCase();
    var catLine = product.mainCategory ? (product.mainCategory + (product.subCategory ? " • " + product.subCategory : "")) : "";

    var buyHtml = product.payhipId
      ? buildPayhipButton(product.payhipId, "Buy Now", "bg-blue-600 text-white hover:bg-blue-700")
      : '<div class="text-sm text-gray-500">This item is not yet available for purchase.</div>';

    var bundleHtml = "";
    if (product.bundlePayhipId) {
      var bl = product.bundleLabel || "Get Bundle & Save";
      bundleHtml =
        '<div class="mt-3">' +
          buildPayhipButton(product.bundlePayhipId, bl, "bg-indigo-600 text-white hover:bg-indigo-700") +
          (product.bundleNote ? '<div class="text-xs text-gray-500 mt-2">' + escapeHtml(product.bundleNote) + '</div>' : "") +
        '</div>';
    }

    var recs = getRecommendations(product, 4);
    var recHtml = "";
    if (recs.length) {
      recHtml =
        '<div class="mt-6 border-t border-gray-200 pt-4">' +
          '<div class="text-sm font-extrabold text-gray-900">Recommended with this</div>' +
          '<div class="text-xs text-gray-600 mt-1">Products from the same category, suggested before checkout.</div>' +
          '<div class="mt-3 grid sm:grid-cols-2 gap-3">' +
            recs.map(function(r) {
              var rAction = "";
              if (r.payhipId) {
                rAction = buildPayhipButton(r.payhipId, "Buy", "bg-white text-blue-700 border border-blue-200 hover:bg-blue-50");
              } else if (r.bundlePayhipId) {
                rAction = buildPayhipButton(r.bundlePayhipId, "Bundle", "bg-white text-indigo-700 border border-indigo-200 hover:bg-indigo-50");
              }

              var rOpen = '<button type="button" class="w-full bg-gray-900 text-white font-semibold py-2 rounded-lg hover:bg-black transition text-sm" data-open-product="' + escapeHtml(r.id) + '">View</button>';

              var rButtons = rAction
                ? ('<div class="mt-3 grid grid-cols-2 gap-2">' + rOpen + rAction + '</div>')
                : ('<div class="mt-3">' + rOpen + '</div>');

              return (
                '<div class="border border-gray-200 rounded-xl p-3 bg-white">' +
                  '<div class="grid grid-cols-[64px,1fr] gap-3 items-center">' +
                    '<div class="bg-gray-50 border border-gray-200 rounded-lg p-2 flex items-center justify-center aspect-square">' +
                      '<img data-cover="' + escapeHtml(r.cover||"") + '" alt="' + escapeHtml(r.title||"") + '" class="w-full h-full object-contain" loading="lazy" />' +
                    '</div>' +
                    '<div>' +
                      '<div class="text-xs font-semibold text-gray-500">' + escapeHtml(FORMAT_LABELS[r.format] || (r.format||"").toUpperCase()) + '</div>' +
                      '<div class="text-sm font-bold text-gray-900 line-clamp-2">' + escapeHtml(r.title) + '</div>' +
                      '<div class="mt-1 text-sm font-extrabold text-gray-900">' + escapeHtml(formatMoney(r.price)) + '</div>' +
                    '</div>' +
                  '</div>' +
                  rButtons +
                '</div>'
              );
            }).join("") +
          '</div>' +
        '</div>';
    }

    content.innerHTML =
      '<div class="grid sm:grid-cols-[140px,1fr] gap-4 items-start">' +
        '<div class="bg-gray-50 border border-gray-200 rounded-xl p-3 flex items-center justify-center aspect-[4/5]">' +
          '<img data-cover="' + escapeHtml(product.cover||"") + '" alt="' + escapeHtml(product.title||"") + '" class="w-full h-full object-contain" loading="lazy" />' +
        '</div>' +
        '<div>' +
          (formatLabel ? '<div class="text-xs font-semibold text-blue-700 mb-2">' + escapeHtml(formatLabel) + '</div>' : '') +
          '<div class="text-lg font-extrabold text-gray-900 leading-snug">' + escapeHtml(product.title) + '</div>' +
          (catLine ? '<div class="text-sm text-gray-500 mt-1">' + escapeHtml(catLine) + '</div>' : '') +
          (product.description ? '<div class="text-sm text-gray-700 mt-3 leading-relaxed">' + escapeHtml(product.description) + '</div>' : '') +
          (product.info ? '<div class="text-xs text-gray-500 mt-2">' + escapeHtml(product.info) + '</div>' : '') +
          '<div class="mt-4 flex items-baseline gap-2">' +
            '<div class="text-2xl font-extrabold text-gray-900">' + escapeHtml(formatMoney(product.price)) + '</div>' +
            (product.compareAt ? '<div class="text-sm text-gray-500 line-through">' + escapeHtml(formatMoney(product.compareAt)) + '</div>' : '') +
          '</div>' +
          '<div class="mt-4">' + buyHtml + bundleHtml + '</div>' +
          recHtml +
        '</div>' +
      '</div>';

    content.querySelectorAll("img[data-cover]").forEach(function(img) {
      setImgSrcWithFallback(img, img.getAttribute("data-cover"));
    });

    // wire recommended "View" buttons
    content.querySelectorAll('[data-open-product]').forEach(function(btn) {
      btn.addEventListener("click", function(e) {
        e.preventDefault();
        var pid = btn.getAttribute("data-open-product");
        var p = PRODUCTS.find(function(x) { return x.id === pid; });
        if (p) openProductModal(p);
      });
    });

    modal.classList.remove("hidden");
    initPayhipButtons();
  }

  function closeProductModal() {
    var modal = document.getElementById("productModal");
    if (!modal) return;
    modal.classList.add("hidden");
  }

  function debounce(fn, delay) {
    var t = null;
    return function() {
      var args = arguments;
      clearTimeout(t);
      t = setTimeout(function() { fn.apply(null, args); }, delay);
    };
  }

  document.addEventListener("DOMContentLoaded", function() {
    var mb = document.getElementById("mobileMenuBtn");
    var mm = document.getElementById("mobileMenu");
    if (mb && mm) mb.addEventListener("click", function() { mm.classList.toggle("hidden"); });

    document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
      anchor.addEventListener("click", function(e) {
        var href = anchor.getAttribute("href");
        if (!href || href === "#") return;
        var target = document.querySelector(href);
        if (!target) return;
        e.preventDefault();
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });

    document.addEventListener("click", function(e) {
      var modal = document.getElementById("productModal");
      if (!modal || modal.classList.contains("hidden")) return;
      if (e.target === modal) closeProductModal();
    });

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") closeProductModal();
    });

    function initProductsAndUI() {
      buildSearchIndex();
      renderCategoryCards();
      renderFooterCategories();
      renderCategorySelect();
      renderSubcategorySelect();
      renderFormatChips();
      renderCatalog();
    }

    loadProductsFromJson().then(initProductsAndUI);

    var search = document.getElementById("searchInput");
    if (search) {
      search.addEventListener("input", debounce(function() {
        STATE.q = search.value || "";
        STATE.limit = 25;
        renderCatalog();
      }, 120));
    }

    var cat = document.getElementById("categorySelect");
    if (cat) {
      cat.addEventListener("change", function() {
        STATE.category = cat.value || "";
        STATE.subcategory = "";
        STATE.limit = 25;
        renderSubcategorySelect();
        renderCatalog();
      });
    }

    var sub = document.getElementById("subcategorySelect");
    if (sub) {
      sub.addEventListener("change", function() {
        STATE.subcategory = sub.value || "";
        STATE.limit = 25;
        renderCatalog();
      });
    }

    var price = document.getElementById("priceSelect");
    if (price) {
      price.addEventListener("change", function() {
        STATE.price = price.value || "all";
        STATE.limit = 25;
        renderCatalog();
      });
    }

    var clearBtn = document.getElementById("clearFiltersBtn");
    if (clearBtn) clearBtn.addEventListener("click", function() { clearFilters(); });

    var loadMoreBtn = document.getElementById("loadMoreBtn");
    if (loadMoreBtn) loadMoreBtn.addEventListener("click", function() { STATE.limit += 25; renderCatalog(); });
  });
</script>
</body>
</html>
