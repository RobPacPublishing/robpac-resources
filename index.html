<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RobPac Resources - Digital Products</title>
  <meta name="description" content="Premium digital resources for entrepreneurs: guides, templates, prompt packs, audio, and more." />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Payhip (required) -->
  <script src="https://payhip.com/payhip.js" type="text/javascript"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    .line-clamp-2 {
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .line-clamp-3 {
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
    }
    .card {
      transition: transform .15s ease, box-shadow .15s ease;
      cursor:pointer;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 22px -10px rgb(0 0 0 / 0.16);
    }
    .imgwrap {
      background:#f9fafb;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:.5rem;
      aspect-ratio: 1 / 1; /* NO CROPPING: both square + book covers */
    }
    .imgwrap img {
      width:100%;
      height:100%;
      object-fit:contain;
      max-height:160px;
    }
  </style>
</head>

<body class="bg-gray-50">
<!-- ROBPAC_RESOURCES_BUILD: FIX_IMAGES_PAYHIP_V1 -->

<header class="bg-white border-b border-gray-200 sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="RobPac Resources" class="h-14 w-14 sm:h-16 sm:w-16" />
        <div>
          <div class="text-lg sm:text-xl font-extrabold text-gray-900 leading-tight">ROBPAC RESOURCES</div>
          <div class="text-xs text-gray-500 uppercase tracking-wide">Digital Products</div>
        </div>
      </div>

      <nav class="hidden md:flex items-center gap-8 text-sm font-semibold">
        <a href="#browse" class="text-gray-700 hover:text-blue-600">Browse</a>
        <a href="#catalog" class="text-gray-700 hover:text-blue-600">Catalog</a>
        <a href="#faq" class="text-gray-700 hover:text-blue-600">FAQ</a>
        <a href="https://robpacpublishing.com" class="text-gray-700 hover:text-blue-600">Main Site</a>
      </nav>

      <button id="mobileMenuBtn" class="md:hidden p-2 rounded-lg border border-gray-200 hover:bg-gray-50" type="button" aria-label="Open menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>

    <div id="mobileMenu" class="hidden md:hidden mt-4 border-t border-gray-100 pt-4">
      <div class="flex flex-col gap-3 text-sm font-semibold">
        <a href="#browse" class="text-gray-700 hover:text-blue-600">Browse</a>
        <a href="#catalog" class="text-gray-700 hover:text-blue-600">Catalog</a>
        <a href="#faq" class="text-gray-700 hover:text-blue-600">FAQ</a>
        <a href="https://robpacpublishing.com" class="text-gray-700 hover:text-blue-600">Main Site</a>
      </div>
    </div>
  </div>
</header>

<section class="bg-gradient-to-b from-white to-gray-50 py-10 sm:py-14">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl">
      <div class="inline-flex items-center gap-2 bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1.5 rounded-full mb-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        New resources added weekly
      </div>

      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 leading-tight">Premium Digital Resources for Entrepreneurs</h1>
      <p class="mt-3 text-gray-600 text-base sm:text-lg">Guides, templates, prompt packs, audio programs, and more. Browse by category, then open any item for the full details.</p>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <a href="#browse" class="inline-flex items-center justify-center bg-blue-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-700 transition">Browse Categories</a>
        <a href="#catalog" class="inline-flex items-center justify-center bg-white text-blue-700 border border-blue-200 font-bold px-6 py-3 rounded-lg hover:bg-blue-50 transition">Go to Catalog</a>
      </div>
    </div>
  </div>
</section>

<section id="browse" class="py-10 bg-white border-t border-gray-100">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-end justify-between gap-6 mb-6">
      <div>
        <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900">Browse by Category</h2>
        <p class="text-sm text-gray-600 mt-1">Pick a category to jump into the catalog.</p>
      </div>
      <a href="#catalog" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">Go to catalog</a>
    </div>

    <div id="categoryCards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4"></div>

    <div class="mt-10">
      <div class="flex items-end justify-between gap-6 mb-4">
        <div>
          <h3 class="text-lg font-extrabold text-gray-900">Featured</h3>
          <p class="text-sm text-gray-600 mt-1">Curated picks across categories.</p>
        </div>
        <a href="#catalog" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">Browse all</a>
      </div>
      <div id="featuredRow" class="flex gap-4 overflow-x-auto no-scrollbar pb-2"></div>
    </div>
  </div>
</section>

<section id="catalog" class="py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-8">
      <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">Browse Our Catalog</h2>
      <p class="text-sm sm:text-base text-gray-600 mt-2">Built for hundreds of products: indexed search, fast filters, and incremental rendering.</p>
    </div>

    <div class="grid lg:grid-cols-12 gap-6">
      <aside class="lg:col-span-3 bg-white border border-gray-200 rounded-2xl p-4 sm:p-5 shadow-sm">
        <div class="font-extrabold text-gray-900 mb-3">Filters</div>

        <label class="text-xs font-bold text-gray-700">Search</label>
        <input id="searchInput" type="text" class="mt-2 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Search title / description..." />

        <div class="mt-4">
          <label class="text-xs font-bold text-gray-700">Filter by Category</label>
          <select id="categorySelect" class="mt-2 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
            <option value="">All Categories</option>
          </select>

          <div class="mt-2 text-[11px] text-gray-500">Subcategories will be enabled when data is provided.</div>

          <select id="subcategorySelect" class="mt-3 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" disabled>
            <option value="">All Subcategories</option>
          </select>
        </div>

        <div class="mt-4 border-t border-gray-100 pt-4">
          <div class="text-xs font-bold text-gray-700 mb-2">Filter by Format</div>
          <div id="formatFilters" class="space-y-2 text-sm"></div>
        </div>

        <div class="mt-4 border-t border-gray-100 pt-4">
          <div class="text-xs font-bold text-gray-700 mb-2">Price</div>
          <select id="priceSelect" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
            <option value="all">All</option>
            <option value="under15">Under $15</option>
            <option value="15to30">$15–$30</option>
            <option value="30plus">$30+</option>
          </select>
        </div>

        <button id="clearBtn" type="button" class="mt-5 w-full bg-white text-blue-700 border border-blue-200 font-bold py-2.5 rounded-lg hover:bg-blue-50 transition text-sm">Clear filters</button>
      </aside>

      <main class="lg:col-span-9">
        <div class="flex items-center justify-between gap-4 mb-4">
          <div class="text-sm text-gray-600"><span id="resultsCount" class="font-extrabold text-gray-900">0</span> results</div>
          <button id="loadMoreBtn" type="button" class="hidden bg-white text-blue-700 border border-blue-200 font-bold px-4 py-2 rounded-lg hover:bg-blue-50 transition text-sm">Load more</button>
        </div>

        <div id="productsGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
      </main>
    </div>
  </div>
</section>

<section id="faq" class="py-12 bg-white border-t border-gray-100">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-8">
      <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">FAQ</h2>
      <p class="text-sm sm:text-base text-gray-600 mt-2">Access, delivery, licensing.</p>
    </div>

    <div class="max-w-3xl mx-auto space-y-4">
      <details class="bg-gray-50 rounded-xl p-5 border border-gray-200">
        <summary class="cursor-pointer font-bold text-gray-900">How do I access my purchase?</summary>
        <div class="mt-3 text-gray-700 text-sm leading-relaxed">After checkout, Payhip provides instant access and a confirmation email with your download link.</div>
      </details>

      <details class="bg-gray-50 rounded-xl p-5 border border-gray-200">
        <summary class="cursor-pointer font-bold text-gray-900">Commercial use?</summary>
        <div class="mt-3 text-gray-700 text-sm leading-relaxed">Where specified, items can be used in your business. Always follow the licensing terms included with each product.</div>
      </details>

      <details class="bg-gray-50 rounded-xl p-5 border border-gray-200">
        <summary class="cursor-pointer font-bold text-gray-900">Refunds?</summary>
        <div class="mt-3 text-gray-700 text-sm leading-relaxed">Refund eligibility depends on the product terms shown at checkout. Use your Payhip receipt details to reference your order.</div>
      </details>
    </div>
  </div>
</section>

<footer class="bg-gray-900 text-gray-300 py-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid md:grid-cols-3 gap-8">
      <div>
        <div class="flex items-center gap-2 mb-3">
          <img src="logo.png" alt="RobPac Resources" class="h-10 w-10" />
          <div class="text-white font-extrabold">ROBPAC RESOURCES</div>
        </div>
        <div class="text-sm">Premium digital resources for entrepreneurs.</div>
      </div>

      <div>
        <div class="text-white font-bold mb-3">Quick Links</div>
        <div class="space-y-2 text-sm">
          <a href="#browse" class="block hover:text-white">Browse</a>
          <a href="#catalog" class="block hover:text-white">Catalog</a>
          <a href="#faq" class="block hover:text-white">FAQ</a>
          <a href="https://robpacpublishing.com" class="block hover:text-white">Main Site</a>
        </div>
      </div>

      <div>
        <div class="text-white font-bold mb-3">Support</div>
        <div class="space-y-2 text-sm">
          <a href="mailto:robpacpublishing@gmail.com" class="block hover:text-white">robpacpublishing@gmail.com</a>
        </div>
      </div>
    </div>

    <div class="border-t border-gray-800 mt-8 pt-6 text-center text-sm">
      © 2025 RobPac Resources
    </div>
  </div>
</footer>

<!-- Product Detail Modal -->
<div id="productModal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full relative">
    <button id="modalCloseBtn" type="button" class="absolute top-3 right-3 p-2 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-50" aria-label="Close">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
    <div id="productModalContent" class="p-4 sm:p-5 max-h-[70vh] overflow-y-auto"></div>
  </div>
</div>

<script>
  // -----------------------------------------
  // DATA
  // -----------------------------------------

  // Categories must match BOTH: Browse by Category + Filter by Category.
  const CATEGORIES = [
    { name: "Marketing", subcategories: [] },
    { name: "Sales & Conversion", subcategories: [] },
    { name: "Business & Growth", subcategories: [] },
    { name: "Creator & Media", subcategories: [] },
    { name: "Productivity & Systems", subcategories: [] },
    { name: "Mindset & Personal Growth", subcategories: [] },
    { name: "Career & Freelancing", subcategories: [] },
    { name: "Health & Wellness", subcategories: [] },
    { name: "Technology & Security", subcategories: [] },
    { name: "Special Topics", subcategories: [] }
  ];

  // Formats (from your list)
  const FORMAT_LIST = [
    "Book", "Video", "Listicle", "Checklist", "Notion Template", "Mini-Course",
    "Guide", "Audio", "Prompt Pack", "Template", "Toolstack", "Workbook"
  ];

  // Products: keep lightweight fields for speed. Admin generator can replace/append this array.
  // REQUIRED: id, title, category. OPTIONAL: subcategory, format, description, price, compareAt, cover, payhipId.
  // <!-- ADMIN_GENERATOR_INSERT_PRODUCTS_START -->
  const PRODUCTS = [
    {
      id: "sample-1",
      title: "Instagram Marketing Mastery",
      category: "Marketing",
      subcategory: "",
      format: "Video",
      description: "Complete video course on growing your Instagram business presence.",
      price: 27,
      compareAt: 37,
      cover: "covers/instagram-marketing-mastery.png",
      payhipId: ""
    },
    {
      id: "sample-2",
      title: "Email Marketing Blueprint",
      category: "Marketing",
      subcategory: "",
      format: "Guide",
      description: "Build and monetize your email list with a clear, structured plan.",
      price: 17,
      compareAt: 27,
      cover: "covers/email-marketing-blueprint.png",
      payhipId: ""
    },
    {
      id: "sample-3",
      title: "Productivity Mastery",
      category: "Productivity & Systems",
      subcategory: "",
      format: "Audio",
      description: "Audio lessons to help you build a calmer, stronger routine.",
      price: 27,
      compareAt: 37,
      cover: "covers/productivity-mastery.png",
      payhipId: ""
    }
  ];
  // <!-- ADMIN_GENERATOR_INSERT_PRODUCTS_END -->

  // Featured: curated list by id (optional)
  const FEATURED_IDS = ["sample-1", "sample-2", "sample-3"];

  // -----------------------------------------
  // UTIL
  // -----------------------------------------

  function escapeHtml(str) {
    return String(str ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function normalize(str) {
    return String(str ?? "").toLowerCase().trim();
  }

  function money(n) {
    const v = Number(n);
    if (!isFinite(v)) return "";
    return "$" + v.toFixed(0);
  }

  

  function coverUrl(raw) {
    const s = String(raw ?? "").trim();
    if (!s) return "";
    if (s.startsWith("http://") || s.startsWith("https://") || s.startsWith("data:") || s.startsWith("/")) return s;
    if (s.startsWith("covers/")) return "/" + s;
    return "/covers/" + s.replace(/^\.?\//, "");
  }

  // Tries alternate extensions (png/jpg/jpeg/webp). If all fail, uses an inline SVG placeholder.
  function imgFallback(img) {
    try {
      if (!img) return;
      const raw = img.getAttribute("data-raw") || img.getAttribute("src") || "";
      const normalized = coverUrl(raw) || "";
      const current = img.getAttribute("src") || normalized;
      const base = normalized.replace(/\.(png|jpg|jpeg|webp)$/i, "");
      const exts = ["png", "jpg", "jpeg", "webp"];

      const tried = new Set((img.dataset.tried || "").split("|").filter(Boolean));
      if (current) tried.add(current);

      for (const ext of exts) {
        const candidate = base + "." + ext;
        if (!tried.has(candidate)) {
          img.dataset.tried = Array.from(tried).concat([candidate]).join("|");
          img.src = candidate;
          return;
        }
      }

      img.removeAttribute("onerror");
      img.src = "data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22400%22%20height%3D%22400%22%20viewBox%3D%220%200%20400%20400%22%3E%0A%20%20%3Crect%20width%3D%22400%22%20height%3D%22400%22%20fill%3D%22%23f3f4f6%22/%3E%0A%20%20%3Cg%20fill%3D%22%239ca3af%22%3E%0A%20%20%20%20%3Cpath%20d%3D%22M120%20260h160v18H120z%22/%3E%0A%20%20%20%20%3Cpath%20d%3D%22M140%20120h120a20%2020%200%200%201%2020%2020v80a20%2020%200%200%201-20%2020H140a20%2020%200%200%201-20-20v-80a20%2020%200%200%201%2020-20zm0%2020v80h120v-80H140z%22/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22175%22%20r%3D%2212%22/%3E%0A%20%20%20%20%3Cpath%20d%3D%22M150%20220l40-35%2025%2022%2035-30%2020%2018v25H150z%22/%3E%0A%20%20%3C/g%3E%0A%3C/svg%3E";
    } catch (e) {
      try { img.removeAttribute("onerror"); img.src = "data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22400%22%20height%3D%22400%22%20viewBox%3D%220%200%20400%20400%22%3E%0A%20%20%3Crect%20width%3D%22400%22%20height%3D%22400%22%20fill%3D%22%23f3f4f6%22/%3E%0A%20%20%3Cg%20fill%3D%22%239ca3af%22%3E%0A%20%20%20%20%3Cpath%20d%3D%22M120%20260h160v18H120z%22/%3E%0A%20%20%20%20%3Cpath%20d%3D%22M140%20120h120a20%2020%200%200%201%2020%2020v80a20%2020%200%200%201-20%2020H140a20%2020%200%200%201-20-20v-80a20%2020%200%200%201%2020-20zm0%2020v80h120v-80H140z%22/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22175%22%20r%3D%2212%22/%3E%0A%20%20%20%20%3Cpath%20d%3D%22M150%20220l40-35%2025%2022%2035-30%2020%2018v25H150z%22/%3E%0A%20%20%3C/g%3E%0A%3C/svg%3E"; } catch (e2) {}
    }
  }
function initPayhip() {
    try {
      if (window.Payhip && window.Payhip.Button && typeof window.Payhip.Button.init === "function") {
        window.Payhip.Button.init();
      }
    } catch (e) {}
  }

  function payhipButtonHtml(payhipId, label) {
    if (!payhipId) return "";
    const safe = escapeHtml(payhipId);
    return `<a class="payhip-buy-button inline-flex items-center justify-center w-full bg-blue-600 text-white font-extrabold py-2.5 rounded-lg hover:bg-blue-700 transition text-sm"
              data-product="${safe}" data-theme="blue" href="https://payhip.com/b/${safe}">${escapeHtml(label || "Buy Now")}</a>`;
  }

  // -----------------------------------------
  // STATE (fast filters)
  // -----------------------------------------

  const STATE = {
    q: "",
    category: "",
    subcategory: "",
    formats: new Set(["ALL"]),
    price: "all",
    limit: 30
  };

  function buildSearchIndex() {
    for (const p of PRODUCTS) {
      p.__search = normalize([p.title, p.description, p.category, p.subcategory, p.format].join(" "));
    }
  }

  function activeFormats() {
    if (STATE.formats.has("ALL")) return null;
    return Array.from(STATE.formats);
  }

  function priceOk(price) {
    const p = Number(price) || 0;
    if (STATE.price === "under15") return p > 0 && p < 15;
    if (STATE.price === "15to30") return p >= 15 && p <= 30;
    if (STATE.price === "30plus") return p >= 30;
    return true;
  }

  function filteredProducts() {
    const q = normalize(STATE.q);
    const formats = activeFormats();

    return PRODUCTS.filter(p => {
      if (STATE.category && p.category !== STATE.category) return false;
      if (STATE.subcategory && (p.subcategory || "") !== STATE.subcategory) return false;
      if (formats && formats.length && formats.indexOf(p.format) === -1) return false;
      if (!priceOk(p.price)) return false;
      if (q && !p.__search.includes(q)) return false;
      return true;
    });
  }

  // -----------------------------------------
  // RENDER: Categories + Featured
  // -----------------------------------------

  function renderCategoryCards() {
    const el = document.getElementById("categoryCards");
    if (!el) return;
    el.innerHTML = "";

    for (const c of CATEGORIES) {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "text-left bg-white border border-gray-200 rounded-xl px-4 py-3 hover:border-blue-200 hover:shadow-sm transition";
      b.innerHTML = `<div class="text-[10px] font-extrabold text-gray-500">CATEGORY</div>
                     <div class="mt-1 font-extrabold text-gray-900 text-sm">${escapeHtml(c.name)}</div>`;
      b.addEventListener("click", () => {
        setCategory(c.name);
      });
      el.appendChild(b);
    }
  }

  function renderFeaturedRow() {
    const el = document.getElementById("featuredRow");
    if (!el) return;
    el.innerHTML = "";

    const featured = FEATURED_IDS
      .map(id => PRODUCTS.find(p => p.id === id))
      .filter(Boolean);

    for (const p of featured) {
      el.appendChild(productCardEl(p, true));
    }
  }

  // -----------------------------------------
  // RENDER: Filters
  // -----------------------------------------

  function renderCategorySelect() {
    const sel = document.getElementById("categorySelect");
    if (!sel) return;
    const current = sel.value || "";
    sel.innerHTML = `<option value="">All Categories</option>` + CATEGORIES.map(c => `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join("");
    sel.value = current;
  }

  function renderSubcategorySelect() {
    const subSel = document.getElementById("subcategorySelect");
    if (!subSel) return;

    if (!STATE.category) {
      subSel.disabled = true;
      subSel.innerHTML = `<option value="">All Subcategories</option>`;
      return;
    }

    const c = CATEGORIES.find(x => x.name === STATE.category);
    const subs = (c && Array.isArray(c.subcategories)) ? c.subcategories : [];
    subSel.disabled = subs.length === 0;

    subSel.innerHTML = `<option value="">All Subcategories</option>` + subs.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  }

  function renderFormatFilters() {
    const el = document.getElementById("formatFilters");
    if (!el) return;

    const rows = [];
    rows.push(`
      <label class="flex items-center gap-2">
        <input type="checkbox" class="h-4 w-4" data-format="ALL" checked />
        <span class="text-sm">All Formats</span>
      </label>
    `);

    for (const f of FORMAT_LIST) {
      rows.push(`
        <label class="flex items-center gap-2">
          <input type="checkbox" class="h-4 w-4" data-format="${escapeHtml(f)}" />
          <span class="text-sm">${escapeHtml(f)}</span>
        </label>
      `);
    }

    el.innerHTML = rows.join("");

    el.querySelectorAll("input[data-format]").forEach(inp => {
      inp.addEventListener("change", () => {
        const val = inp.getAttribute("data-format");
        if (!val) return;

        if (val === "ALL") {
          STATE.formats = new Set(["ALL"]);
        } else {
          if (STATE.formats.has("ALL")) STATE.formats.delete("ALL");
          if (inp.checked) STATE.formats.add(val); else STATE.formats.delete(val);
          if (STATE.formats.size === 0) STATE.formats.add("ALL");
        }

        syncFormatCheckboxes();
        STATE.limit = 30;
        renderCatalog();
      });
    });
  }

  function syncFormatCheckboxes() {
    const box = document.getElementById("formatFilters");
    if (!box) return;
    const all = STATE.formats.has("ALL");

    box.querySelectorAll("input[data-format]").forEach(inp => {
      const val = inp.getAttribute("data-format");
      if (!val) return;
      if (val === "ALL") {
        inp.checked = all;
      } else {
        inp.checked = !all && STATE.formats.has(val);
      }
    });
  }

  // -----------------------------------------
  // RENDER: Catalog
  // -----------------------------------------

  function productCardEl(p, compactFeatured) {
    const card = document.createElement("div");
    card.className = "card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden";
    if (compactFeatured) {
      card.classList.add("min-w-[210px]", "max-w-[210px]");
    }

    const badge = p.format ? `<div class="text-[10px] font-extrabold text-gray-500 mb-1">${escapeHtml(p.format)}</div>` : "";
    const sub = (p.category ? `${escapeHtml(p.category)}` : "") + (p.subcategory ? ` • ${escapeHtml(p.subcategory)}` : "");

    card.innerHTML = `
      <div class="imgwrap">
        ${p.cover ? `<img src="${escapeHtml(coverUrl(p.cover))}" data-raw="${escapeHtml(p.cover)}" onerror="imgFallback(this)" alt="${escapeHtml(p.title)}" loading="lazy" />` : ""}
      </div>
      <div class="p-3">
        ${badge}
        <div class="text-sm font-extrabold text-gray-900 line-clamp-2">${escapeHtml(p.title)}</div>
        ${p.description ? `<div class="mt-1 text-xs text-gray-600 line-clamp-2">${escapeHtml(p.description)}</div>` : ""}
        <div class="mt-3 flex items-baseline gap-2">
          ${p.price ? `<div class="text-base font-extrabold text-gray-900">${money(p.price)}</div>` : ""}
          ${p.compareAt ? `<div class="text-xs text-gray-500 line-through">${money(p.compareAt)}</div>` : ""}
        </div>
        <div class="mt-1 text-[11px] text-gray-500 line-clamp-1">${sub}</div>
      </div>
    `;

    card.addEventListener("click", (e) => {
      if (e.target.closest("a") || e.target.closest("button")) return;
      openModal(p);
    });

    return card;
  }

  function renderCatalog() {
    const grid = document.getElementById("productsGrid");
    const count = document.getElementById("resultsCount");
    const loadMore = document.getElementById("loadMoreBtn");
    if (!grid || !count || !loadMore) return;

    const list = filteredProducts();
    count.textContent = String(list.length);

    const shown = list.slice(0, STATE.limit);

    grid.innerHTML = "";
    const frag = document.createDocumentFragment();
    for (const p of shown) frag.appendChild(productCardEl(p, false));
    grid.appendChild(frag);

    loadMore.classList.toggle("hidden", list.length <= STATE.limit);
  }

  // -----------------------------------------
  // MODAL (compact + Payhip safe)
  // -----------------------------------------

  function openModal(p) {
    const modal = document.getElementById("productModal");
    const content = document.getElementById("productModalContent");
    if (!modal || !content || !p) return;

    const catLine = (p.category ? escapeHtml(p.category) : "") + (p.subcategory ? " • " + escapeHtml(p.subcategory) : "");
    const buy = p.payhipId ? payhipButtonHtml(p.payhipId, "Buy Now") : `<div class="text-sm text-gray-500">This item is not yet available for purchase.</div>`;

    content.innerHTML = `
      <div class="grid sm:grid-cols-[140px,1fr] gap-4 items-start">
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-3 flex items-center justify-center aspect-[4/5]">
          ${p.cover ? `<img src="${escapeHtml(coverUrl(p.cover))}" data-raw="${escapeHtml(p.cover)}" onerror="imgFallback(this)" alt="${escapeHtml(p.title)}" class="w-full h-full object-contain" loading="lazy" />` : ""}
        </div>
        <div>
          ${p.format ? `<div class="text-xs font-extrabold text-blue-700 mb-2">${escapeHtml(p.format)}</div>` : ""}
          <div class="text-lg font-extrabold text-gray-900 leading-snug">${escapeHtml(p.title)}</div>
          ${catLine ? `<div class="text-sm text-gray-500 mt-1">${catLine}</div>` : ""}
          ${p.description ? `<div class="text-sm text-gray-700 mt-3 leading-relaxed">${escapeHtml(p.description)}</div>` : ""}
          <div class="mt-4 flex items-baseline gap-2">
            ${p.price ? `<div class="text-2xl font-extrabold text-gray-900">${money(p.price)}</div>` : ""}
            ${p.compareAt ? `<div class="text-sm text-gray-500 line-through">${money(p.compareAt)}</div>` : ""}
          </div>
          <div class="mt-4">${buy}</div>
        </div>
      </div>
    `;

    modal.classList.remove("hidden");

    // Payhip must keep working after re-render
    initPayhip();

    // Prevent modal click-through opening/closing issues
    modal.querySelectorAll(".payhip-buy-button").forEach(a => {
      a.addEventListener("click", (e) => e.stopPropagation());
    });
  }

  function closeModal() {
    const modal = document.getElementById("productModal");
    if (modal) modal.classList.add("hidden");
  }

  // -----------------------------------------
  // ACTIONS
  // -----------------------------------------

  function setCategory(cat) {
    STATE.category = cat || "";
    STATE.subcategory = "";
    STATE.limit = 30;

    const sel = document.getElementById("categorySelect");
    if (sel) sel.value = STATE.category;

    renderSubcategorySelect();
    const subSel = document.getElementById("subcategorySelect");
    if (subSel) subSel.value = "";

    renderCatalog();
    document.getElementById("catalog")?.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function clearFilters() {
    STATE.q = "";
    STATE.category = "";
    STATE.subcategory = "";
    STATE.formats = new Set(["ALL"]);
    STATE.price = "all";
    STATE.limit = 30;

    const s = document.getElementById("searchInput");
    if (s) s.value = "";
    const c = document.getElementById("categorySelect");
    if (c) c.value = "";
    const sub = document.getElementById("subcategorySelect");
    if (sub) {
      sub.value = "";
      sub.disabled = true;
      sub.innerHTML = `<option value="">All Subcategories</option>`;
    }
    const p = document.getElementById("priceSelect");
    if (p) p.value = "all";

    syncFormatCheckboxes();
    renderCatalog();
  }

  function debounce(fn, delay) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  // -----------------------------------------
  // INIT
  // -----------------------------------------

  document.addEventListener("DOMContentLoaded", () => {
    // mobile menu
    const mb = document.getElementById("mobileMenuBtn");
    const mm = document.getElementById("mobileMenu");
    mb?.addEventListener("click", () => mm?.classList.toggle("hidden"));

    // smooth anchor scroll
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener("click", (e) => {
        const href = a.getAttribute("href");
        if (!href || href === "#") return;
        const target = document.querySelector(href);
        if (!target) return;
        e.preventDefault();
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });

    // modal close wiring
    document.getElementById("modalCloseBtn")?.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });
    document.getElementById("productModal")?.addEventListener("click", (e) => {
      if (e.target && e.target.id === "productModal") closeModal();
    });

    buildSearchIndex();

    renderCategoryCards();
    renderFeaturedRow();

    renderCategorySelect();
    renderSubcategorySelect();
    renderFormatFilters();
    syncFormatCheckboxes();

    renderCatalog();

    // filters
    const search = document.getElementById("searchInput");
    search?.addEventListener("input", debounce(() => {
      STATE.q = search.value || "";
      STATE.limit = 30;
      renderCatalog();
    }, 140));

    const catSel = document.getElementById("categorySelect");
    catSel?.addEventListener("change", () => {
      STATE.category = catSel.value || "";
      STATE.subcategory = "";
      STATE.limit = 30;
      renderSubcategorySelect();
      renderCatalog();
    });

    const subSel = document.getElementById("subcategorySelect");
    subSel?.addEventListener("change", () => {
      STATE.subcategory = subSel.value || "";
      STATE.limit = 30;
      renderCatalog();
    });

    const priceSel = document.getElementById("priceSelect");
    priceSel?.addEventListener("change", () => {
      STATE.price = priceSel.value || "all";
      STATE.limit = 30;
      renderCatalog();
    });

    document.getElementById("clearBtn")?.addEventListener("click", clearFilters);

    const loadMore = document.getElementById("loadMoreBtn");
    loadMore?.addEventListener("click", () => {
      STATE.limit += 30;
      renderCatalog();
    });

    // Payhip for initial render
    initPayhip();
  });
</script>
</body>
</html>
